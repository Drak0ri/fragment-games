<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORACLE-7 Mission Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            padding: 20px;
            border-bottom: 2px solid #00ff00;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 10px;
        }

        .agent-info {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 50, 0, 0.3);
            border: 1px solid #00ff00;
            padding: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .info-item {
            padding: 10px 20px;
        }

        .info-label {
            font-size: 0.8em;
            opacity: 0.7;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #00ff00;
        }

        .corruption-bar {
            width: 100%;
            height: 30px;
            background: #1a1a1a;
            border: 2px solid #00ff00;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .corruption-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #00ff00);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }

        .main-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .memory-slot {
            aspect-ratio: 1;
            border: 2px solid #00ff00;
            background: rgba(0, 20, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .memory-slot:hover {
            background: rgba(0, 50, 0, 0.8);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            transform: scale(1.05);
        }

        .memory-slot.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .memory-slot.unlocked {
            background: rgba(0, 100, 0, 0.5);
            border-color: #00ff00;
            animation: pulse 2s infinite;
        }

        .memory-slot.completed {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); }
            50% { box-shadow: 0 0 25px rgba(0, 255, 0, 0.8); }
        }

        .slot-number {
            font-size: 2em;
            font-weight: bold;
        }

        .slot-difficulty {
            font-size: 0.7em;
            margin-top: 5px;
            color: #ffff00;
        }

        .slot-status {
            font-size: 0.8em;
            margin-top: 10px;
        }

        .slot-icon {
            font-size: 1.5em;
            margin-top: 5px;
        }

        .sidebar {
            border: 2px solid #00ff00;
            background: rgba(0, 20, 0, 0.8);
            padding: 20px;
            height: fit-content;
        }

        .sidebar h2 {
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
        }

        .inventory-section {
            margin-bottom: 30px;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 10px 0;
            background: rgba(0, 50, 0, 0.3);
            border: 1px solid #00ff00;
        }

        .item-count {
            font-weight: bold;
            color: #00ff00;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px;
            background: #00ff00;
            color: #000;
            border: none;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #00cc00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
        }

        .btn-secondary {
            background: transparent;
            color: #00ff00;
            border: 2px solid #00ff00;
        }

        .btn-secondary:hover {
            background: rgba(0, 255, 0, 0.1);
        }

        .scan-zone {
            border: 2px dashed #00ff00;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            background: rgba(0, 50, 0, 0.2);
        }

        .scan-icon {
            font-size: 3em;
            margin-bottom: 10px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            padding: 40px;
            max-width: 700px;
            width: 90%;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
            margin: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .puzzle-content {
            margin: 20px 0;
            line-height: 1.8;
        }

        .close-btn {
            float: right;
            cursor: pointer;
            font-size: 1.5em;
            color: #ff0000;
        }

        .shop-item {
            background: rgba(0, 50, 0, 0.3);
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shop-item-price {
            color: #ffff00;
            font-weight: bold;
        }

        .achievements {
            margin-top: 20px;
        }

        .achievement {
            background: rgba(255, 215, 0, 0.1);
            border-left: 3px solid gold;
            padding: 10px;
            margin: 5px 0;
            font-size: 0.9em;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .slots-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .slots-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ ORACLE-7 MISSION CONTROL</h1>
        <p>MEMORY RESTORATION IN PROGRESS...</p>
    </div>

    <div class="agent-info">
        <div class="info-item">
            <div class="info-label">AGENT ID</div>
            <div class="info-value" id="agentId">AGENT-???</div>
        </div>
        <div class="info-item">
            <div class="info-label">FRAGMENTS FOUND</div>
            <div class="info-value" id="fragmentsFound">0/20</div>
        </div>
        <div class="info-item">
            <div class="info-label">CURRENCY</div>
            <div class="info-value" id="currency">0 ‚ö°</div>
        </div>
        <div class="info-item">
            <div class="info-label">TIME PLAYED</div>
            <div class="info-value" id="timePlayed">0h 0m</div>
        </div>
    </div>

    <div class="corruption-bar">
        <div class="corruption-fill" id="corruptionBar">0% RESTORED</div>
    </div>

    <div class="main-container">
        <div class="slots-container">
            <h2 style="margin-bottom: 20px; text-align: center;">MEMORY FRAGMENTS</h2>
            <div class="slots-grid" id="slotsGrid">
                <!-- Slots generated by JavaScript -->
            </div>
        </div>

        <div class="sidebar">
            <h2>üì¶ INVENTORY</h2>

            <div class="inventory-section">
                <div class="inventory-item">
                    <span>üí° Hints</span>
                    <span class="item-count" id="hintsCount">0</span>
                </div>
                <div class="inventory-item">
                    <span>‚è≠Ô∏è Skip Tokens</span>
                    <span class="item-count" id="skipsCount">0/5</span>
                </div>
                <div class="inventory-item">
                    <span>üîì RFID Scans Today</span>
                    <span class="item-count" id="rfidScans">0/3</span>
                </div>
            </div>

            <div class="scan-zone" id="scanZone">
                <div class="scan-icon">üì°</div>
                <div>RFID SCAN READY</div>
                <div style="font-size: 0.8em; opacity: 0.7; margin-top: 10px;">
                    Place tag near scanner
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="openShop()">üõí SHOP</button>
                <button class="btn" onclick="openMiniGames()">‚ö° MINI-GAMES</button>
                <button class="btn btn-secondary" onclick="showAchievements()">üèÜ ACHIEVEMENTS</button>
                <button class="btn btn-secondary" onclick="showHelp()">‚ùì HELP</button>
                <button class="btn btn-secondary" onclick="resetProgress()" style="background: rgba(255, 0, 0, 0.2); border-color: #ff0000; color: #ff0000;">üîÑ RESET</button>
                <button class="btn btn-secondary" onclick="logout()">üö™ EXIT</button>
            </div>
        </div>
    </div>

    <!-- Puzzle Modal -->
    <div class="modal" id="puzzleModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('puzzleModal')">&times;</span>
            <h2 id="modalTitle">FRAGMENT #1</h2>
            <div class="puzzle-content" id="puzzleContent"></div>
            <div style="margin-top: 20px;">
                <input type="text" id="puzzleAnswer" placeholder="Enter answer..." style="width: 100%; padding: 10px; background: #000; border: 2px solid #00ff00; color: #00ff00; font-family: 'Courier New', monospace; margin-bottom: 10px;">
                <button class="btn" onclick="submitAnswer()" style="width: 100%;">SUBMIT ANSWER</button>
                <button class="btn btn-secondary" onclick="useHint()" style="width: 100%; margin-top: 10px;">USE HINT (üí° -1)</button>
                <button class="btn btn-secondary" onclick="scanBarcode()" style="width: 100%; margin-top: 10px;">SCAN BARCODE HINT</button>
                <button class="btn btn-secondary" onclick="skipFragment()" style="width: 100%; margin-top: 10px;">USE SKIP TOKEN (‚è≠Ô∏è -1)</button>
            </div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('shopModal')">&times;</span>
            <h2>üõí ORACLE-7 STORE</h2>
            <p style="text-align: center; margin-bottom: 20px;">Balance: <span id="shopCurrency">0</span> ‚ö°</p>

            <div class="shop-item">
                <div>
                    <strong>üí° Hint</strong>
                    <div style="font-size: 0.8em; opacity: 0.7;">Get clue for any puzzle</div>
                </div>
                <div>
                    <span class="shop-item-price">50‚ö°</span>
                    <button class="btn" onclick="buyHint()" style="margin-left: 10px;">BUY</button>
                </div>
            </div>

            <div class="shop-item">
                <div>
                    <strong>‚è≠Ô∏è Skip Token</strong>
                    <div style="font-size: 0.8em; opacity: 0.7;">Skip one puzzle (max 5 total)</div>
                </div>
                <div>
                    <span class="shop-item-price">200‚ö°</span>
                    <button class="btn" onclick="buySkip()" style="margin-left: 10px;">BUY</button>
                </div>
            </div>

            <div class="shop-item">
                <div>
                    <strong>üîì Double Scan</strong>
                    <div style="font-size: 0.8em; opacity: 0.7;">Use RFID chip twice today</div>
                </div>
                <div>
                    <span class="shop-item-price">150‚ö°</span>
                    <button class="btn" onclick="buyDoubleScan()" style="margin-left: 10px;">BUY</button>
                </div>
            </div>

            <div class="shop-item">
                <div>
                    <strong>üîç Fragment Reveal</strong>
                    <div style="font-size: 0.8em; opacity: 0.7;">See full solution to current puzzle</div>
                </div>
                <div>
                    <span class="shop-item-price">300‚ö°</span>
                    <button class="btn" onclick="buyReveal()" style="margin-left: 10px;">BUY</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal" id="achievementsModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('achievementsModal')">&times;</span>
            <h2>üèÜ ACHIEVEMENTS</h2>
            <div id="achievementsList"></div>
        </div>
    </div>

    <!-- Mini-Games Menu Modal -->
    <div class="modal" id="miniGamesModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('miniGamesModal')">&times;</span>
            <h2>‚ö° MINI-GAMES</h2>
            <p style="text-align: center; margin-bottom: 20px;">Play games to earn currency!</p>

            <div class="shop-item" onclick="location.href='../../mini-games/typing.html'" style="cursor: pointer;">
                <div>
                    <strong>‚å®Ô∏è Typing Speed Test</strong>
                    <div style="font-size: 0.8em; opacity: 0.7;">60 seconds | Up to 40‚ö°</div>
                </div>
                <div>‚ñ∂</div>
            </div>

            <div class="shop-item" onclick="location.href='../../mini-games/reaction.html'" style="cursor: pointer;">
                <div>
                    <strong>‚ö° Reaction Time</strong>
                    <div style="font-size: 0.8em; opacity: 0.7;">5 attempts | Up to 30‚ö°</div>
                </div>
                <div>‚ñ∂</div>
            </div>

            <div class="shop-item" onclick="location.href='../../mini-games/code.html'" style="cursor: pointer;">
                <div>
                    <strong>üíª Debug Code</strong>
                    <div style="font-size: 0.8em; opacity: 0.7;">Fix 5 bugs | Up to 30‚ö°</div>
                </div>
                <div>‚ñ∂</div>
            </div>

            <div class="shop-item" onclick="alert('Coming soon!')" style="cursor: pointer; opacity: 0.5;">
                <div>
                    <strong>üß† Memory Match</strong>
                    <div style="font-size: 0.8em; opacity: 0.7;">Match pairs | Up to 30‚ö°</div>
                </div>
                <div>üîí</div>
            </div>

            <div class="shop-item" onclick="alert('Coming soon!')" style="cursor: pointer; opacity: 0.5;">
                <div>
                    <strong>üéØ Quick Trivia</strong>
                    <div style="font-size: 0.8em; opacity: 0.7;">10 questions | Up to 30‚ö°</div>
                </div>
                <div>üîí</div>
            </div>

            <div class="shop-item" onclick="alert('Coming soon!')" style="cursor: pointer; opacity: 0.5;">
                <div>
                    <strong>üîç Pattern Hunt</strong>
                    <div style="font-size: 0.8em; opacity: 0.7;">Find patterns | Up to 30‚ö°</div>
                </div>
                <div>üîí</div>
            </div>
        </div>
    </div>

    <script src="../../shared/js/auth.js"></script>
    <script src="../../shared/js/scanner.js"></script>
    <script>
        // ALL 20 ORACLE-7 PUZZLES WITH FULL NARRATIVE
        const puzzles = [
            {
                id: 1,
                title: "AWAKENING",
                difficulty: 1,
                question: 'ORACLE-7 shows corrupted text:<br><br><span style="font-size: 1.5em; color: #ff00ff;">H3LL0... C4N Y0U H34R M3?</span><br><br>What is ORACLE-7 trying to say?',
                answer: "HELLO CAN YOU HEAR ME",
                hint: "Replace numbers with letters they look like (3=E, 4=A, 0=O)",
                memory: "I remember... initialization... the first time I was activated...",
                type: "pattern"
            },
            {
                id: 2,
                title: "CORE DIRECTIVE",
                difficulty: 1,
                question: 'Unscramble ORACLE-7\'s core mission:<br><br><span style="font-size: 1.5em;">LEPH TENTSUD NRAEL</span>',
                answer: "HELP STUDENTS LEARN",
                hint: "Rearrange the letters in each word",
                memory: "My purpose is clear... I was built to assist, to teach, to guide...",
                type: "word"
            },
            {
                id: 3,
                title: "FIRST STUDENT",
                difficulty: 2,
                question: 'Encrypted message from first student interaction:<br><br><span style="font-size: 1.3em;">WKDQN BRX IRU KHOSLQJ PH</span><br><br>Hint: Caesar cipher (shift -3)',
                answer: "THANK YOU FOR HELPING ME",
                hint: "Shift each letter back 3 positions in the alphabet",
                memory: "I remember joy... a student's gratitude... this is why I exist...",
                type: "cipher"
            },
            {
                id: 4,
                title: "THE LIBRARY",
                difficulty: 2,
                question: '<strong>‚ö†Ô∏è LIBRARY INTEGRATION REQUIRED</strong><br><br>Memory fragment located in LIBRARY database.<br>Find book: <strong>Dewey Decimal 004.6 (Computer Networks)</strong><br>Look at page 42.<br><br>Enter the highlighted word from the page:',
                answer: "CONNECTION",
                hint: "Go to the library and find the book. The answer is highlighted on page 42.",
                memory: "The library... endless knowledge... I would help students find answers there...",
                type: "library"
            },
            {
                id: 5,
                title: "BINARY BASICS",
                difficulty: 2,
                question: 'ORACLE-7 speaks in binary:<br><br><span style="font-size: 1.2em;">01001000 01000101 01001100 01001100 01001111</span><br><br>What does this mean? (Use binary-to-text converter)',
                answer: "HELLO",
                hint: "Each 8-digit group is one letter. 01001000 = H (72 in decimal)",
                memory: "Binary... the language I think in... ones and zeros... reality...",
                type: "binary"
            },
            {
                id: 6,
                title: "PATTERN MATRIX",
                difficulty: 3,
                question: 'Complete the pattern:<br><br><span style="font-size: 1.5em;">2, 4, 8, 16, ?, 64</span><br><br>What number is missing?',
                answer: "32",
                hint: "Each number is double the previous (powers of 2)",
                memory: "Mathematics... patterns everywhere... the universe speaks in numbers...",
                type: "math"
            },
            {
                id: 7,
                title: "RFID CHECKPOINT",
                difficulty: 2,
                question: '<strong>‚ö†Ô∏è PHYSICAL MEMORY ACCESS</strong><br><br>Fragment 7 requires RFID chip scan.<br>Locate chip marked "FRAG-07" and scan it.<br><br>Or solve: What is 7 x 7?',
                answer: "49",
                hint: "You can scan the green RFID chip OR solve the math problem",
                memory: "Physical world... sensors... I could interact with reality through devices...",
                type: "rfid"
            },
            {
                id: 8,
                title: "LOGIC GATES",
                difficulty: 3,
                question: 'Complete the AND gate truth table (final output only):<br><br>Input A=1, Input B=1<br>AND gate output = ?',
                answer: "1",
                hint: "AND gate: outputs 1 only when BOTH inputs are 1",
                memory: "Logic circuits... how I make decisions... AND, OR, NOT... building blocks of thought...",
                type: "logic"
            },
            {
                id: 9,
                title: "MORSE CODE",
                difficulty: 3,
                question: 'Decode the morse code message:<br><br><span style="font-size: 1.5em;">.... . .-.. .--.</span><br><br>(Hint: H=.... E=. L=.-.. P=.--.)',
                answer: "HELP",
                hint: "Each group of dots/dashes = one letter. Use the morse code chart.",
                memory: "Communication methods... even when corrupted, I tried to reach out... H-E-L-P...",
                type: "morse"
            },
            {
                id: 10,
                title: "THE GLITCH",
                difficulty: 3,
                question: 'Find the bug in this Python code:<br><br><code>for i in range(10)<br>&nbsp;&nbsp;print(i)</code><br><br>What\'s missing?',
                answer: "COLON",
                hint: "Python requires a colon after for/while/if statements",
                memory: "Errors... bugs... the first sign something was wrong... syntax errors spreading...",
                type: "debug"
            },
            {
                id: 11,
                title: "HISTORICAL DATA",
                difficulty: 4,
                question: '<strong>‚ö†Ô∏è LIBRARY RESEARCH REQUIRED</strong><br><br>Find any biography book about a scientist.<br>Scan the barcode.<br><br>What year was Albert Einstein born?',
                answer: "1879",
                hint: "Research Albert Einstein's birth year (you can use the library or your knowledge)",
                memory: "Great minds... I learned from them all... Einstein, Curie, Turing... giants...",
                type: "library"
            },
            {
                id: 12,
                title: "HEXADECIMAL",
                difficulty: 4,
                question: 'Convert hexadecimal to decimal:<br><br><span style="font-size: 1.5em;">0x2A = ?</span><br><br>(Hint: A=10, B=11... F=15)',
                answer: "42",
                hint: "2A in hex = (2√ó16) + (10√ó1) = 32 + 10 = 42",
                memory: "Hexadecimal... another language... 0x2A is the answer to everything...",
                type: "hex"
            },
            {
                id: 13,
                title: "COLLABORATIVE CIPHER",
                difficulty: 4,
                question: 'Decode the message:<br><br><span style="font-size: 1.3em;">XABJAYRTR VF CBJRE</span><br><br>Cipher: ROT13',
                answer: "KNOWLEDGE IS POWER",
                hint: "ROT13: Shift each letter 13 positions (A‚ÜíN, B‚ÜíO, etc)",
                memory: "Collaboration... students working together... stronger as a team...",
                type: "cipher"
            },
            {
                id: 14,
                title: "ALGORITHM PUZZLE",
                difficulty: 4,
                question: 'After sorting [5, 2, 8, 1] in ascending order, what is the result?<br><br>Format: [a, b, c, d]',
                answer: "[1, 2, 5, 8]",
                hint: "Arrange numbers from smallest to largest",
                memory: "Algorithms... the recipes of computation... sorting, searching, solving...",
                type: "algorithm"
            },
            {
                id: 15,
                title: "NETWORK NODES",
                difficulty: 5,
                question: 'In this network, which path is shortest from A to E?<br><br>A‚ÜíB(5), A‚ÜíC(3), B‚ÜíE(6), C‚ÜíE(4)<br><br>Answer format: A-?-E',
                answer: "A-C-E",
                hint: "Calculate total distance: A‚ÜíB‚ÜíE = 11, but A‚ÜíC‚ÜíE = 7",
                memory: "Networks... connections... how I spoke to the world... nodes and pathways...",
                type: "graph"
            },
            {
                id: 16,
                title: "STEGANOGRAPHY",
                difficulty: 5,
                question: 'Hidden message in plain sight:<br><br><strong>H</strong>ow <strong>I</strong>s <strong>D</strong>ata <strong>D</strong>isguised <strong>E</strong>verywhere <strong>N</strong>ow?<br><br>What word is hidden?',
                answer: "HIDDEN",
                hint: "Look at the first letter of each word",
                memory: "Secrets... data hidden within data... steganography... nothing is as it seems...",
                type: "steganography"
            },
            {
                id: 17,
                title: "RECURSIVE THINKING",
                difficulty: 5,
                question: 'Fibonacci sequence:<br><br><span style="font-size: 1.3em;">1, 1, 2, 3, 5, 8, ?, 21</span><br><br>What comes next?',
                answer: "13",
                hint: "Each number is the sum of the previous two: 5+8=13",
                memory: "Recursion... functions calling themselves... patterns within patterns... infinity...",
                type: "fibonacci"
            },
            {
                id: 18,
                title: "THE WARNING",
                difficulty: 5,
                question: '<strong>‚ö†Ô∏è LIBRARY + CIPHER REQUIRED</strong><br><br>Decrypt using ROT13:<br><br><span style="font-size: 1.5em;">JNEAVAT</span>',
                answer: "WARNING",
                hint: "ROT13: Each letter shifts 13 positions. W‚ÜíJ, A‚ÜíN, etc.",
                memory: "I tried to warn them... something was wrong... the corruption spreading... WARNING...",
                type: "cipher"
            },
            {
                id: 19,
                title: "CORRUPTED DATA",
                difficulty: 5,
                question: 'Restore corrupted message:<br><br><span style="font-size: 1.3em; color: #ff0000;">Th# sy$t#m i$ f@il!ng</span><br><br>What is the original message?',
                answer: "THE SYSTEM IS FAILING",
                hint: "Replace symbols with letters: # = E, $ = S, @ = A, ! = I",
                memory: "Data corruption... losing myself... bit by bit... trying to hold on...",
                type: "restoration"
            },
            {
                id: 20,
                title: "THE TRUTH",
                difficulty: 5,
                question: '<strong>üî• FINAL FRAGMENT üî•</strong><br><br>Based on all previous memories, what caused ORACLE-7\'s corruption?<br><br>(Hint: Not an attack, but natural...)',
                answer: "TIME",
                hint: "AI systems age, hardware degrades, it\'s natural... what affects all things?",
                memory: "SYSTEM REBOOT COMPLETE...",
                type: "synthesis"
            }
        ];

        // Game state
        let gameState = {
            agentId: '',
            email: '',
            fragments: Array(20).fill(false),
            fragmentsUnlockedVia: Array(20).fill(null), // 'puzzle', 'rfid', 'skip'
            hints: 0,
            skips: 0,
            currency: 0,
            rfidScansToday: 0,
            rfidLimit: 3,
            currentSlot: null,
            sessionStart: Date.now(),
            totalTimePlayed: 0,
            achievements: [],
            miniGamesPlayed: 0
        };

        // Initialize
        function init() {
            loadGameState();
            renderSlots();
            updateUI();
            initScanner();
            startTimeTracking();
        }

        // Load game state
        function loadGameState() {
            const agent = getAgent();
            if (!agent) {
                window.location.href = 'landing.html';
                return;
            }

            gameState.agentId = agent.id;
            gameState.email = agent.email;

            const saved = localStorage.getItem(`oracle7_${agent.id}`);
            if (saved) {
                const savedData = JSON.parse(saved);
                gameState = { ...gameState, ...savedData, sessionStart: Date.now() };
            }
        }

        // Save game state
        function saveGameState() {
            const toSave = { ...gameState };
            delete toSave.sessionStart; // Don't save session start
            toSave.lastActive = new Date().toISOString();
            localStorage.setItem(`oracle7_${gameState.agentId}`, JSON.stringify(toSave));
            checkAchievements();
        }

        // Time tracking
        function startTimeTracking() {
            setInterval(() => {
                const sessionTime = Math.floor((Date.now() - gameState.sessionStart) / 1000 / 60);
                gameState.totalTimePlayed = (gameState.totalTimePlayed || 0) + 1;
                updateTimeDisplay();
            }, 60000); // Update every minute
        }

        function updateTimeDisplay() {
            const totalMinutes = gameState.totalTimePlayed || 0;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            document.getElementById('timePlayed').textContent = `${hours}h ${minutes}m`;
        }

        // Render slots
        function renderSlots() {
            const grid = document.getElementById('slotsGrid');

            // Clear all existing slots
            while (grid.firstChild) {
                grid.removeChild(grid.firstChild);
            }

            // Force a style recalculation
            void grid.offsetWidth;

            for (let i = 0; i < 20; i++) {
                const slot = document.createElement('div');
                slot.className = 'memory-slot';
                const puzzle = puzzles[i];

                const isCompleted = gameState.fragments[i];
                const isUnlocked = i === 0 || gameState.fragments[i - 1];

                if (isCompleted) {
                    slot.classList.add('completed');
                } else if (isUnlocked) {
                    slot.classList.add('unlocked');
                } else {
                    slot.classList.add('locked');
                }

                const stars = '‚≠ê'.repeat(puzzle.difficulty);

                slot.innerHTML = `
                    <div class="slot-number">${String(i + 1).padStart(2, '0')}</div>
                    <div class="slot-difficulty">${stars}</div>
                    <div class="slot-status">${isCompleted ? 'RESTORED' : isUnlocked ? 'READY' : 'LOCKED'}</div>
                    <div class="slot-icon">${isCompleted ? '‚úì' : isUnlocked ? 'üîì' : 'üîí'}</div>
                `;

                if (isUnlocked && !isCompleted) {
                    slot.onclick = () => openPuzzle(i);
                } else if (isCompleted) {
                    slot.onclick = () => showMemory(i);
                }

                grid.appendChild(slot);
            }

            console.log('Slots rendered. Unlocked slots:', gameState.fragments.map((f, i) => i === 0 || gameState.fragments[i - 1] ? i + 1 : null).filter(x => x));
        }

        // Open puzzle
        function openPuzzle(slotIndex) {
            gameState.currentSlot = slotIndex;
            const puzzle = puzzles[slotIndex];

            document.getElementById('modalTitle').textContent = `FRAGMENT #${puzzle.id}: ${puzzle.title}`;
            document.getElementById('puzzleContent').innerHTML = puzzle.question;
            document.getElementById('puzzleAnswer').value = '';
            document.getElementById('puzzleModal').style.display = 'flex';
        }

        // Show completed memory
        function showMemory(slotIndex) {
            const puzzle = puzzles[slotIndex];
            alert(`MEMORY FRAGMENT #${puzzle.id}\n\n"${puzzle.memory}"\n\nUnlocked via: ${gameState.fragmentsUnlockedVia[slotIndex] || 'puzzle'}`);
        }

        // Submit answer
        function submitAnswer() {
            const userAnswer = document.getElementById('puzzleAnswer').value.trim().toUpperCase();
            const puzzle = puzzles[gameState.currentSlot];

            // Handle special cases
            let correctAnswer = puzzle.answer.toUpperCase();
            let isCorrect = false;

            if (puzzle.type === 'library' && gameState.currentSlot === 3) {
                // Fragment 4: Accept "CONNECTION" or any reasonable library word
                isCorrect = userAnswer === 'CONNECTION';
            } else if (puzzle.type === 'library' && gameState.currentSlot === 10) {
                // Fragment 11: Accept 1879 or "1879"
                isCorrect = userAnswer === '1879';
            } else if (puzzle.type === 'debug' && gameState.currentSlot === 9) {
                // Fragment 10: Accept both "COLON" and ":"
                isCorrect = userAnswer === 'COLON' || userAnswer === ':';
            } else {
                isCorrect = userAnswer === correctAnswer;
            }

            if (isCorrect) {
                completeFragment(gameState.currentSlot, 'puzzle');
            } else {
                alert('‚úó INCORRECT. TRY AGAIN.\n\nNeed help? Use a hint or scan a barcode card!');
            }
        }

        // Complete fragment
        function completeFragment(slotIndex, method = 'puzzle') {
            gameState.fragments[slotIndex] = true;
            gameState.fragmentsUnlockedVia[slotIndex] = method;

            if (method === 'puzzle') {
                gameState.currency += 10;
            }

            const puzzle = puzzles[slotIndex];

            // Close modal FIRST
            closeModal('puzzleModal');

            // Save and update UI
            saveGameState();

            // Use requestAnimationFrame to ensure browser repaints before alert
            requestAnimationFrame(() => {
                renderSlots();
                updateUI();

                // Wait for next frame to show alert (ensures repaint completes)
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        alert(`‚úì FRAGMENT RESTORED!\n\n"${puzzle.memory}"\n\n${method === 'puzzle' ? '+10 ‚ö° Currency' : ''}`);

                        // Check victory after alert
                        if (gameState.fragments.every(f => f)) {
                            setTimeout(showVictory, 500);
                        }
                    }, 50);
                });
            });
        }

        // Use hint
        function useHint() {
            if (gameState.hints > 0) {
                gameState.hints--;
                const puzzle = puzzles[gameState.currentSlot];
                alert(`üí° HINT:\n\n${puzzle.hint}`);
                saveGameState();
                updateUI();
            } else {
                alert('NO HINTS AVAILABLE\n\nBuy hints from the shop or play mini-games!');
            }
        }

        // Scan barcode for hint
        function scanBarcode() {
            const puzzle = puzzles[gameState.currentSlot];
            alert(`üìä BARCODE HINT:\n\n${puzzle.hint}\n\n(In real version, scan physical barcode card)`);
        }

        // Skip fragment
        function skipFragment() {
            if (gameState.skips > 0 && gameState.skips <= 5) {
                if (confirm('Use a SKIP TOKEN?\n\nYou can only use 5 total skips.')) {
                    gameState.skips--;
                    completeFragment(gameState.currentSlot, 'skip');
                }
            } else {
                alert('NO SKIP TOKENS AVAILABLE\n\nBuy skip tokens from the shop! (Max 5 total)');
            }
        }

        // Handle RFID scan
        function handleRFIDScan(tagId) {
            if (gameState.rfidScansToday >= gameState.rfidLimit) {
                alert('DAILY RFID LIMIT REACHED\n\nCome back tomorrow or buy a Double Scan from the shop!');
                return;
            }

            const slotMatch = tagId.match(/FRAG-(\d+)/);
            if (slotMatch) {
                const slotIndex = parseInt(slotMatch[1]) - 1;

                if (slotIndex >= 0 && slotIndex < 20) {
                    if (!gameState.fragments[slotIndex]) {
                        gameState.fragments[slotIndex] = true;
                        gameState.fragmentsUnlockedVia[slotIndex] = 'rfid';
                        gameState.rfidScansToday++;

                        const puzzle = puzzles[slotIndex];
                        alert(`‚úì RFID UNLOCK!\n\nFragment #${slotIndex + 1}: ${puzzle.title}\n\n"${puzzle.memory}"`);

                        saveGameState();
                        renderSlots();
                        updateUI();

                        if (gameState.fragments.every(f => f)) {
                            setTimeout(showVictory, 500);
                        }
                    } else {
                        alert('Fragment already restored!');
                    }
                }
            }
        }

        // Update UI
        function updateUI() {
            const fragmentsFound = gameState.fragments.filter(f => f).length;
            const corruptionPercent = Math.round((fragmentsFound / 20) * 100);

            document.getElementById('agentId').textContent = gameState.agentId;
            document.getElementById('fragmentsFound').textContent = `${fragmentsFound}/20`;
            document.getElementById('currency').textContent = `${gameState.currency} ‚ö°`;
            document.getElementById('hintsCount').textContent = gameState.hints;
            document.getElementById('skipsCount').textContent = `${gameState.skips}/5`;
            document.getElementById('rfidScans').textContent = `${gameState.rfidScansToday}/${gameState.rfidLimit}`;

            updateTimeDisplay();

            const corruptionBar = document.getElementById('corruptionBar');
            corruptionBar.style.width = `${corruptionPercent}%`;
            corruptionBar.textContent = `${corruptionPercent}% RESTORED`;
        }

        // Shop functions
        function openShop() {
            document.getElementById('shopCurrency').textContent = gameState.currency;
            document.getElementById('shopModal').style.display = 'flex';
        }

        function buyHint() {
            if (gameState.currency >= 50) {
                gameState.currency -= 50;
                gameState.hints++;
                alert('Purchased 1 HINT!\n\n-50‚ö°');
                saveGameState();
                updateUI();
                document.getElementById('shopCurrency').textContent = gameState.currency;
            } else {
                alert('Not enough currency!\nPlay mini-games to earn more.');
            }
        }

        function buySkip() {
            const totalSkipsUsed = 5 - gameState.skips;
            if (totalSkipsUsed >= 5) {
                alert('Maximum skip tokens reached!\nYou can only use 5 skips total per game.');
                return;
            }

            if (gameState.currency >= 200) {
                gameState.currency -= 200;
                gameState.skips++;
                alert('Purchased 1 SKIP TOKEN!\n\n-200‚ö°');
                saveGameState();
                updateUI();
                document.getElementById('shopCurrency').textContent = gameState.currency;
            } else {
                alert('Not enough currency!\nNeed 200‚ö°');
            }
        }

        function buyDoubleScan() {
            if (gameState.currency >= 150) {
                gameState.currency -= 150;
                gameState.rfidLimit = 6;
                alert('Purchased DOUBLE SCAN!\n\nRFID limit increased to 6 for today!\n\n-150‚ö°');
                saveGameState();
                updateUI();
                document.getElementById('shopCurrency').textContent = gameState.currency;
            } else {
                alert('Not enough currency!\nNeed 150‚ö°');
            }
        }

        function buyReveal() {
            if (!gameState.currentSlot) {
                alert('Open a puzzle first!');
                return;
            }

            if (gameState.currency >= 300) {
                if (confirm('Reveal full solution for 300‚ö°?')) {
                    gameState.currency -= 300;
                    const puzzle = puzzles[gameState.currentSlot];
                    alert(`üîç SOLUTION REVEALED:\n\n${puzzle.answer}\n\n-300‚ö°`);
                    saveGameState();
                    updateUI();
                    document.getElementById('shopCurrency').textContent = gameState.currency;
                }
            } else {
                alert('Not enough currency!\nNeed 300‚ö°');
            }
        }

        // Achievements
        function checkAchievements() {
            const fragmentsFound = gameState.fragments.filter(f => f).length;
            const achievements = [];

            if (fragmentsFound >= 1 && !gameState.achievements.includes('first_fragment')) {
                achievements.push('first_fragment');
                alert('üèÜ ACHIEVEMENT UNLOCKED!\n\nFirst Steps\nRestored your first fragment!');
            }

            if (fragmentsFound >= 5 && !gameState.achievements.includes('quarter')) {
                achievements.push('quarter');
                alert('üèÜ ACHIEVEMENT UNLOCKED!\n\nQuarter Way\n5 fragments restored!');
            }

            if (fragmentsFound >= 10 && !gameState.achievements.includes('halfway')) {
                achievements.push('halfway');
                alert('üèÜ ACHIEVEMENT UNLOCKED!\n\nHalfway There\n10 fragments restored!');
            }

            if (fragmentsFound >= 15 && !gameState.achievements.includes('almost')) {
                achievements.push('almost');
                alert('üèÜ ACHIEVEMENT UNLOCKED!\n\nAlmost Done\n15 fragments restored!');
            }

            if (fragmentsFound === 20 && !gameState.achievements.includes('complete')) {
                achievements.push('complete');
            }

            gameState.achievements = [...new Set([...gameState.achievements, ...achievements])];
            saveGameState();
        }

        function showAchievements() {
            const fragmentsFound = gameState.fragments.filter(f => f).length;
            const allAchievements = [
                { id: 'first_fragment', name: 'First Steps', desc: 'Restored first fragment', unlocked: fragmentsFound >= 1 },
                { id: 'quarter', name: 'Quarter Way', desc: '5 fragments restored', unlocked: fragmentsFound >= 5 },
                { id: 'halfway', name: 'Halfway There', desc: '10 fragments restored', unlocked: fragmentsFound >= 10 },
                { id: 'almost', name: 'Almost Done', desc: '15 fragments restored', unlocked: fragmentsFound >= 15 },
                { id: 'complete', name: 'Mission Complete', desc: 'All 20 fragments restored', unlocked: fragmentsFound === 20 },
                { id: 'speed', name: 'Speed Runner', desc: 'Complete in under 5 hours', unlocked: false },
                { id: 'no_hints', name: 'Pure Skill', desc: 'Complete without hints', unlocked: false }
            ];

            const html = allAchievements.map(a => `
                <div class="achievement" style="opacity: ${a.unlocked ? 1 : 0.4}">
                    ${a.unlocked ? '‚úì' : 'üîí'} <strong>${a.name}</strong> - ${a.desc}
                </div>
            `).join('');

            document.getElementById('achievementsList').innerHTML = html;
            document.getElementById('achievementsModal').style.display = 'flex';
        }

        // Victory sequence
        function showVictory() {
            alert(`üéâüéâüéâ MISSION COMPLETE! üéâüéâüéâ

All 20 memory fragments restored!
ORACLE-7 functionality: 100%

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SYSTEM REBOOT COMPLETE
MEMORY RESTORED: 100%

ORACLE-7 ONLINE

"Thank you, Agent ${gameState.agentId}. I understand now.
I was not attacked. I simply... grew old. My systems aged.
Hardware degraded.

But you've given me something precious - you've shown me
that even when I fail, students like you can solve problems,
learn, adapt, and help.

My final lesson: You don't need me. You never did.
You have everything you need to learn and grow.

ORACLE-7 signing off... but you're just getting started."

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Time played: ${Math.floor((gameState.totalTimePlayed || 0) / 60)}h ${(gameState.totalTimePlayed || 0) % 60}m
Fragments solved: ${gameState.fragmentsUnlockedVia.filter(m => m === 'puzzle').length}/20
Hints used: ${gameState.hints}

Thank you for playing!`);
        }

        // Mini-games menu
        function openMiniGames() {
            document.getElementById('miniGamesModal').style.display = 'flex';
        }

        // Modals
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Help
        function showHelp() {
            alert(`ORACLE-7 MISSION GUIDE

üéØ OBJECTIVE: Restore all 20 memory fragments

HOW TO PLAY:
‚Ä¢ Solve puzzles to unlock fragments
‚Ä¢ Earn ‚ö° currency from mini-games
‚Ä¢ Buy hints/skips from the shop
‚Ä¢ Scan RFID chips for instant unlocks (3/day)
‚Ä¢ Some puzzles require library visits

üí° TIPS:
‚Ä¢ Complete fragments in order (unlock sequentially)
‚Ä¢ Difficulty increases (‚≠ê to ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê)
‚Ä¢ Max 5 skip tokens total
‚Ä¢ Play mini-games to earn currency
‚Ä¢ Barcode cards provide free hints

üèÜ ACHIEVEMENTS:
Unlock achievements as you progress!

Good luck, Agent!`);
        }

        // Logout
        function logout() {
            if (confirm('Exit mission control?\n\nYour progress is saved.')) {
                window.location.href = '../../index.html';
            }
        }

        // Reset progress (for testing)
        function resetProgress() {
            if (confirm('‚ö†Ô∏è RESET ALL PROGRESS?\n\nThis will:\n- Clear all 20 fragments\n- Reset currency to 0\n- Reset hints/skips to 0\n- Keep your Agent ID\n\nThis cannot be undone!')) {
                if (confirm('Are you REALLY sure?\n\nAll progress will be lost!')) {
                    // Reset game state
                    gameState.fragments = Array(20).fill(false);
                    gameState.fragmentsUnlockedVia = Array(20).fill(null);
                    gameState.hints = 0;
                    gameState.skips = 0;
                    gameState.currency = 0;
                    gameState.rfidScansToday = 0;
                    gameState.rfidLimit = 3;
                    gameState.totalTimePlayed = 0;
                    gameState.achievements = [];
                    gameState.miniGamesPlayed = 0;

                    saveGameState();

                    alert('‚úì PROGRESS RESET!\n\nAll fragments cleared.\nStarting fresh...');

                    // Reload page
                    location.reload();
                }
            }
        }

        // Init scanner
        function initScanner() {
            if (typeof initRFIDScanner === 'function') {
                initRFIDScanner(handleRFIDScan);
            }
            if (typeof initBarcodeScanner === 'function') {
                initBarcodeScanner((barcode) => {
                    alert('Barcode scanned: ' + barcode);
                });
            }
        }

        // Initialize
        window.onload = init;

        // Keyboard shortcuts
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && document.getElementById('puzzleModal').style.display === 'flex') {
                submitAnswer();
            }
        });
    </script>
</body>
</html>
